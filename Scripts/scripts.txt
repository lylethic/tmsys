create table if not exists approved_status
(
    id         uuid not null
        primary key,
    name       text not null,
    code       text not null
        unique,
    color      text,
    sort_order smallint,
    bgcolor    text,
    type       text not null
);

create table if not exists client_request_log
(
    id               uuid      default gen_random_uuid() not null
        primary key,
    user_id          uuid,
    session_id       uuid,
    client_ip        varchar(50),
    user_agent       text,
    url              text                                not null,
    feature_name     text,
    method           varchar(10)                         not null,
    headers          jsonb,
    body             text,
    status_code      integer,
    response_time_ms integer,
    created          timestamptz,
    updated          timestamptz,
    created_by       uuid,
    updated_by       uuid,
    deleted          boolean   default false             not null,
    active           boolean   default true              not null
);

create table if not exists departments
(
    id          uuid                                   not null
        primary key,
    code        varchar(50)                            not null
        constraint uq_departments_code
            unique,
    name        varchar(255)                           not null
        constraint uq_departments_name
            unique,
    description text,
    parent_id   uuid
        constraint fk_departments_parent
            references departments,
    active      boolean                  default true  not null,
    deleted     boolean                  default false not null,
    created     timestamptz not null,
    updated     timestamptz not null,
    created_by  uuid,
    updated_by  uuid
);

create table if not exists notifications
(
    id                 uuid                            not null
        primary key,
    summary            text                            not null,
    details            text                            not null,
    user_id            uuid                            not null,
    sub_category_type  integer                         not null,
    group_code         text   default ''::text         not null,
    created_at         timestamptz,
    reference_link     text   default ''::text         not null,
    main_category_type integer                         not null,
    expired            timestamptz,
    sent_schedule      timestamptz,
    status_id          uuid,
    image              text   default ''::text         not null,
    user_read          uuid[] default ARRAY []::uuid[] not null
);

create table if not exists otp_codes
(
    id         uuid                                not null
        primary key,
    user_id    uuid                                not null,
    code       varchar(10)                         not null,
    is_used    boolean   default false             not null,
    expired_at timestamptz                           not null,
    created_at timestamptz not null,
    created    timestamptz                           not null,
    updated    timestamptz,
    created_by uuid,
    updated_by uuid,
    deleted    boolean   default false             not null,
    active     boolean   default true              not null
);

create table if not exists permissions
(
    id          uuid                                not null
        primary key,
    name        varchar(255)                        not null
        unique,
    description text,
    created     timestamptz not null,
    updated     timestamptz,
    created_by  uuid,
    updated_by  uuid,
    deleted     boolean   default false             not null,
    active      boolean   default true              not null
);

create table if not exists progress_updates
(
    id                  uuid                                not null
        primary key,
    task_id             uuid                                not null,
    user_id             uuid                                not null,
    update_date         timestamptz not null,
    progress_percentage integer                             not null
        constraint progress_updates_progress_percentage_check
            check ((progress_percentage >= 0) AND (progress_percentage <= 100)),
    notes               text,
    created             timestamptz not null,
    updated             timestamptz,
    created_by          uuid,
    updated_by          uuid,
    deleted             boolean   default false             not null,
    active              boolean   default true              not null
);

create table if not exists project_types
(
    id          uuid                                not null
        primary key,
    name        varchar(255),
    description text,
    created     timestamptz not null,
    updated     timestamptz,
    created_by  uuid,
    updated_by  uuid,
    deleted     boolean   default false             not null,
    active      boolean   default true              not null
);

create table if not exists projects
(
    id           uuid                                             not null
        primary key,
    name         varchar(255)                                     not null,
    description  text,
    start_date   date                                             not null,
    end_date     date,
    manager_id   uuid                                             not null,
    status       varchar(50) default 'Pending'::character varying not null,
    created      timestamptz            not null,
    updated      timestamptz,
    created_by   uuid,
    updated_by   uuid,
    deleted      boolean     default false                        not null,
    active       boolean     default true                         not null,
    project_type uuid
);

create table if not exists reports
(
    id           uuid                                not null
        primary key,
    project_id   uuid                                not null,
    report_date  date                                not null,
    content      text                                not null,
    type         varchar(50)                         not null,
    generated_by uuid,
    created      timestamptz not null,
    updated      timestamptz,
    created_by   uuid,
    updated_by   uuid,
    deleted      boolean   default false             not null,
    active       boolean   default true              not null
);

create table if not exists role_permissions
(
    role_id       uuid                                not null,
    permission_id uuid                                not null,
    created       timestamptz not null,
    updated       timestamptz,
    created_by    uuid,
    updated_by    uuid,
    deleted       boolean   default false             not null,
    active        boolean   default true              not null,
    primary key (role_id, permission_id)
);

create table if not exists roles
(
    id          uuid                                not null
        primary key,
    name        varchar(255)                        not null
        unique,
    description text,
    created     timestamptz not null,
    updated     timestamptz,
    created_by  uuid,
    updated_by  uuid,
    deleted     boolean   default false             not null,
    active      boolean   default true              not null
);

create table if not exists tasks
(
    id                    uuid                                             not null
        primary key,
    project_id            uuid                                             not null,
    name                  varchar(255)                                     not null,
    description           text,
    assigned_to           uuid                                             not null,
    status                varchar(50)   default 'To Do'::character varying not null,
    due_date              date,
    priority              integer       default 1,
    created               timestamptz         not null,
    updated               timestamptz,
    created_by            uuid,
    updated_by            uuid,
    deleted               boolean       default false                      not null,
    active                boolean       default true                       not null,
    update_frequency_days integer       default 7,
    last_progress_update  timestamptz,
    max_point             numeric(5, 2),
    late_penalty          numeric(5, 2) default 0,
    allow_late            boolean       default true,
    allow_resubmit        boolean       default false,
    pass_point            numeric(5, 2),
    completed_at          timestamptz
);

create table if not exists media_assets
(
    id            uuid                                           not null
        primary key,
    public_id     varchar(255)                                   not null
        unique,
    url           text                                           not null,
    secure_url    text                                           not null,
    resource_type varchar(50) default 'image'::character varying not null,
    format        varchar(50),
    bytes         bigint                                         not null,
    width         integer,
    height        integer,
    user_id       uuid,
    project_id    uuid
        constraint fk_media_assets_project
            references projects
            on delete set null,
    task_id       uuid
        constraint fk_media_assets_task
            references tasks
            on delete set null,
    entity_type   varchar(50),
    entity_id     uuid,
    description   text,
    created       timestamptz         not null,
    updated       timestamptz,
    created_by    uuid,
    updated_by    uuid,
    deleted       boolean     default false                      not null,
    active        boolean     default true                       not null,
    constraint chk_media_assets_dimensions
        check (((width IS NULL) AND (height IS NULL)) OR ((width > 0) AND (height > 0)))
);

create table if not exists user_departments
(
    id            uuid                                   not null
        primary key,
    user_id       uuid                                   not null,
    department_id uuid                                   not null,
    is_primary    boolean                  default false not null,
    start_date    date,
    end_date      date,
    active        boolean                  default true  not null,
    deleted       boolean                  default false not null,
    created       timestamptz not null,
    updated       timestamptz,
    created_by    uuid,
    updated_by    uuid,
    constraint uq_user_department
        unique (user_id, department_id)
);

create table if not exists user_roles
(
    user_id    uuid                                not null,
    role_id    uuid                                not null,
    created    timestamptz not null,
    updated    timestamptz,
    created_by uuid,
    updated_by uuid,
    deleted    boolean   default false             not null,
    active     boolean   default true              not null,
    primary key (user_id, role_id)
);

create table if not exists users
(
    id                  uuid                  not null
        primary key,
    username            varchar(255),
    email               varchar(255)          not null
        unique,
    password            varchar(255)          not null,
    name                varchar(255),
    profilepic          varchar(255),
    city                varchar(255),
    created             timestamptz             not null,
    updated             timestamptz,
    created_by          uuid,
    updated_by          uuid,
    deleted             boolean default false not null,
    active              boolean default true  not null,
    last_login_time     timestamptz,
    token               text,
    is_send_email       boolean default true,
    failed_otp_attempts integer default 0,
    lockout_end_at      timestamptz,
    last_otp_sent_at    timestamptz
);

create table if not exists work_schedule
(
    id           uuid                                not null
        primary key,
    intern_id    uuid
        constraint fk_work_schedule_intern
            references users,
    intern_email varchar(255),
    mentor_email varchar(255),
    monday       varchar(255),
    tuesday      varchar(255),
    wednesday    varchar(255),
    thursday     varchar(255),
    friday       varchar(255),
    created      timestamptz not null,
    updated      timestamptz,
    full_name    varchar(50),
    deleted      boolean   default false,
    created_by   uuid,
    updated_by   uuid,
    active       boolean   default true,
    week_start   timestamptz,
    week_end     timestamptz
);

create table if not exists company_geofences
(
    id         uuid                                   not null
        primary key,
    name       text                                   not null,
    center_lat double precision                       not null,
    center_lng double precision                       not null,
    radius_m   integer                                not null,
    active     boolean                  default true  not null,
    deleted    boolean                  default false not null,
    created    timestamptz not null,
    updated    timestamptz,
    created_by uuid,
    updated_by uuid
);

create table if not exists attendance_checkins
(
    id           uuid                                   not null
        primary key,
    user_id      uuid                                   not null,
    checkin_time timestamptz               not null,
    checkin_date date                                   not null,
    lat          double precision                       not null,
    lng          double precision                       not null,
    accuracy_m   integer                                not null,
    distance_m   integer                                not null,
    is_valid     boolean                                not null,
    reason       text,
    device_id    text,
    ip           inet,
    user_agent   text,
    active       boolean                  default true  not null,
    deleted      boolean                  default false not null,
    created      timestamptz not null,
    updated      timestamptz,
    created_by   uuid,
    updated_by   uuid
);

create unique index if not exists ux_attendance_user_day
    on attendance_checkins (user_id, checkin_date);

create index if not exists ix_attendance_user_time
    on attendance_checkins (user_id asc, checkin_time desc);

create table if not exists popups
(
    id             uuid                                   not null
        primary key,
    content        text                                   not null,
    validity_start date                                   not null,
    validity_end   date                                   not null,
    type           smallint                 default 0     not null,
    display_from   timestamptz,
    display_to     timestamptz,
    active         boolean                  default true,
    deleted        boolean                  default false not null,
    created        timestamptz not null,
    updated        timestamptz,
    created_by     uuid,
    updated_by     uuid,
    constraint chk_validity
        check (validity_end >= validity_start)
);

create table if not exists submissions
(
    id                 uuid                                    not null
        primary key,
    task_id            uuid                                    not null
        references tasks,
    user_id            uuid                                    not null
        references users,
    submitted_at       timestamptz               not null,
    is_late            boolean                                 not null,
    raw_point          numeric(5, 2),
    penalty_point      numeric(5, 2) default 0,
    final_score        numeric(5, 2),
    status             varchar(50)                             not null,
    note               text,
    attempt_no         integer       default 1,
    is_pass            boolean,
    approved_status_id uuid
        references approved_status,
    created            timestamptz not null,
    updated            timestamptz,
    created_by         uuid,
    updated_by         uuid,
    deleted            boolean       default false             not null,
    active             boolean       default true              not null
);

create table if not exists project_members
(
    id         uuid                                not null
        primary key,
    project_id uuid                                not null
        references projects,
    member_id  uuid                                not null
        references users,
    role       varchar(20),
    created    timestamptz not null,
    updated    timestamptz,
    created_by uuid,
    updated_by uuid,
    deleted    boolean   default false             not null,
    active     boolean   default true              not null,
    left_at    timestamp
);

create view v_notifications_grouped(extend_user, extend_status, notifications) as
SELECT json_build_object('id', u.id, 'username', u.username, 'name', u.name, 'email', u.email, 'profilepic',
                         u.profilepic, 'city', u.city, 'active', u.active) AS extend_user,
       row_to_json(app.*)                                                  AS extend_status,
       json_agg(row_to_json(n.*))                                          AS notifications
FROM notifications n
         LEFT JOIN users u ON n.user_id = u.id
         LEFT JOIN approved_status app ON app.id = n.status_id
GROUP BY u.id, app.id;

ALTER TABLE client_request_log      ALTER COLUMN created SET DEFAULT now();
ALTER TABLE departments             ALTER COLUMN created SET DEFAULT now();
ALTER TABLE otp_codes               ALTER COLUMN created SET DEFAULT now();
ALTER TABLE permissions             ALTER COLUMN created SET DEFAULT now();
ALTER TABLE progress_updates        ALTER COLUMN created SET DEFAULT now();
ALTER TABLE project_types           ALTER COLUMN created SET DEFAULT now();
ALTER TABLE projects                ALTER COLUMN created SET DEFAULT now();
ALTER TABLE reports                 ALTER COLUMN created SET DEFAULT now();
ALTER TABLE role_permissions        ALTER COLUMN created SET DEFAULT now();
ALTER TABLE roles                   ALTER COLUMN created SET DEFAULT now();
ALTER TABLE tasks                   ALTER COLUMN created SET DEFAULT now();
ALTER TABLE media_assets            ALTER COLUMN created SET DEFAULT now();
ALTER TABLE user_departments        ALTER COLUMN created SET DEFAULT now();
ALTER TABLE user_roles              ALTER COLUMN created SET DEFAULT now();
ALTER TABLE users                   ALTER COLUMN created SET DEFAULT now();
ALTER TABLE work_schedule           ALTER COLUMN created SET DEFAULT now();
ALTER TABLE company_geofences       ALTER COLUMN created SET DEFAULT now();
ALTER TABLE attendance_checkins     ALTER COLUMN created SET DEFAULT now();
ALTER TABLE popups                  ALTER COLUMN created SET DEFAULT now();
ALTER TABLE submissions             ALTER COLUMN created SET DEFAULT now();
ALTER TABLE project_members         ALTER COLUMN created SET DEFAULT now();

CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
