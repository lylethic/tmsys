<!DOCTYPE html>
<html>
	<head>
		<title>SignalR Test Client</title>
		<meta charset="UTF-8" />
		<style>
			body {
				font-family: sans-serif;
			}
			#messagesList li {
				background: #eef;
				margin-bottom: 5px;
				padding: 8px;
				border-radius: 4px;
			}
			#messagesList li.error {
				background: #fdd;
			}
		</style>
	</head>
	<body>
		<h1>SignalR Notification Tester</h1>
		<p>Äang chá» thÃ´ng bÃ¡o tá»« server...</p>
		<ul id="messagesList"></ul>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
		<script>
			// Láº¥y userId tá»« má»™t prompt Ä‘á»ƒ giáº£ láº­p user Ä‘Ã£ Ä‘Äƒng nháº­p
			// Trong á»©ng dá»¥ng tháº­t, báº¡n sáº½ láº¥y tá»« token hoáº·c cookie
			const userId = prompt(
				'Please enter your User ID to join the notification group:',
				'085f532c-91ae-4a3a-a255-61de4a29e479'
			);

			const connection = new signalR.HubConnectionBuilder()
				.withUrl(`/tms/api/hubs/notifications`, {
					// Gá»­i token náº¿u hub cá»§a báº¡n yÃªu cáº§u xÃ¡c thá»±c
					// accessTokenFactory: () => your_auth_token
				})
				.withAutomaticReconnect()
				.configureLogging(signalR.LogLevel.Information)
				.build();

			// Láº¯ng nghe sá»± kiá»‡n "ReceiveMessage" mÃ  server gá»­i
			connection.on('ReceiveMessage', (user, message) => {
				console.log(`Message received from ${user}: ${message}`);
				const li = document.createElement('li');
				li.innerHTML = `<strong>[${user}]</strong>: ${message}`;
				document.getElementById('messagesList').prepend(li);
			});

			async function start() {
				try {
					await connection.start();
					console.log('SignalR Connected.');
					// Sau khi káº¿t ná»‘i, hub trÃªn server sáº½ tá»± Ä‘á»™ng thÃªm client nÃ y vÃ o group
					// cÃ³ tÃªn lÃ  userId (dá»±a trÃªn logic trong OnConnectedAsync)
					const li = document.createElement('li');
					li.textContent = `âœ… Connected to SignalR. Listening for notifications for user: ${userId}`;
					document.getElementById('messagesList').prepend(li);
				} catch (err) {
					console.error(err);
					const li = document.createElement('li');
					li.className = 'error';
					li.textContent = `âŒ SignalR connection failed: ${err}`;
					document.getElementById('messagesList').prepend(li);
					setTimeout(start, 5000); // Thá»­ káº¿t ná»‘i láº¡i sau 5 giÃ¢y
				}
			}

			connection.onclose((error) => {
				console.error(
					`Connection closed due to error: "${error}". Trying to reconnect...`
				);
				const li = document.createElement('li');
				li.className = 'error';
				li.textContent = `ğŸ”Œ Connection closed. Reconnecting...`;
				document.getElementById('messagesList').prepend(li);
			});

			// Báº¯t Ä‘áº§u káº¿t ná»‘i
			if (userId) {
				start();
			} else {
				alert('User ID is required to test.');
			}
		</script>
	</body>
</html>
